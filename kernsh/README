                        	]=------ kernsh ------=[


Kernsh uses Libkernsh which is a library to play with kernel image in real 
time or on disk.

You can obtain all information necessary about kernel(syscalls, idt, gdt, 
symbols, ...), insert module inside the memory, hijack functions, etc

You can profite of eresi's language to define you own structure and 
communicate with the kernel.

Features :
    - Read/Write anywhere in the kernel (static/memory), 
	direcly in ERESI language
    - Display syscalls, idt, gdt, symbols..
    - Disassembling kernel memory
    - Read and modify the static kernel image
    - Alloc/Free kernel memory (contiguous and non contiguous)
    - Inject new compiled LKM code into a static kernel or kernel memory
    - Make md5 of kernel function and portion of code
    - Redirect initialisation of loadable kernel module
    - Redir function

Depends libkernsh : libaspect, libelfsh
Depends kernsh : librevm, libaspect


[+] Installation


Compile Eresi with --enable-kernsh during configure. "make" and "make install".


By default, Libkernsh do the following action :
	- Load ~/.kernshrc
	- If libkernsh.without_kernel is set to 0
		- If libkernsh.use_kernel is set to 1 :
			- Open libkernsh.storagepath + libkernsh.kernelelf

		- Else :
			- Open libkernsh.storagepath + libkernsh.kernel
			- Extract/Gunzip it
			- Open the final kernel

	- Open memory device in libkernsh.device with mode libkernsh.mode 
		and mmap it if libkernsh.mmap is set to 1 (with a size of 
		libkernsh.mmap_size). Mmap is necessary to use all features.

	- Have fun !

You can define all the libkernsh.*, see section Options below.


[+] Portability :

 -------------------------------------------------------------
|   \  ARCH   |  IA32  |  SPARC  | SPARC64 |  MIPS  |  ALPHA  |
| OS \        |        |         |         |        |         |
 -------------------------------------------------------------
|  LINUX 2.4  |  DONE  |   UT    |   UT    |   UT   |   UT    |
|             |        |         |         |        |         |
 -------------------------------------------------------------
|  LINUX 2.6  |  DONE  |   UT    |   UT    |   UT   |   UT    |
|             |        |         |         |        |         |
 -------------------------------------------------------------
|    NETBSD   |  WIP   |         |         |        |         |
|             |        |         |         |        |         |
 -------------------------------------------------------------
|   FREEBSD   |  WIP   |         |         |        |         |
|             |        |         |         |        |         |
 -------------------------------------------------------------


[ 
 legends :
	- WIP		: 	Work In Progress
	- UT 		: 	Untested
]


[+] Commands : 
	- openmem :
		func 	: open kernel memory and by default 
			  gzip static kernel	
		args 	: no
		return 	: /
		options :
		mode	: /

	- closemem :
		func	: close kernel memory and static kernel
		args 	: no
		return	: int
		options : /
		mode	: /

	- mode :
		func	: with no args display the mode
		args	: yes (not obligatory), "static" and "dynamic"
		return  : /
		options :	
	
	- sct :
		func	: handle the syscall table
		args	: -d : display syscall table
			  -n : create new syscall table
		return	: /
		options : /
		mode	: static/dynamic

	- idt :
		func	: handle the idt
		args	: -d : display the idt
		return	: /
		options : /
		mode	: dynamic

	- gdt :
		func	: handle the gdt
		args	: -d : display the gdt
		return	: no
		options : /
		mode	: static/dynamic
		
	- alloc :
		func	: alloc contiguous kernel memory
		args	: size (mandatory)
		return	: $_ is set with the return address
		options : /
		mode	: dynamic

	- free :
		func	: free contiguous kernel memory
		args	: addr (mandatory)
		return	: $_ is set with the return value  
		options : /
		mode	: dynamic

	- alloc_nc :
		func	: alloc non contiguous kernel memory
		args	: size (mandatory)
		return	: $_ is set with the return address
		options : /
		mode	: dynamic

	- free_nc : 
		func	: free non contiguous kernel memory
		args	: addr (mandatory)
		return	: $_ is set with the return value
		options : /
		mode	: dynamic

	- kmodule : 
		func : handle kernel module
		args : 
			-l : load a module with insmod
				sub args : module
				- module : module's pathname (mandatory)
			return	:
			options :
			mode	: static
			-u : unload a module with rmmod
				sub args : module
				- module : module's pathname (mandatory)
			return	:
			options :
			mode	: static
			
			-r : link module with another
				sub args : module1 module2 moduleres
				- module1 : first module's pathname (mandatory)
				- module2 : second module's pathname (mandatory)
				- moduleres : result of two modules (mandatory)
			return	:
			options :
			mode	: static
			-i : infect a module
				sub args : module original_name evil_name
				- module : module's pathname (mandatory)
				- original_name : name of the hijacked function
				- evil_name : name of the hijack function
			return	:
			options :
			mode	: static

	- ksym :
		func	: get an address of a kernel symbol
		args	: symbol's name
		return	: $_ is set with the return address
		options : /
		mode	: dynamic
		
	- virtm : IN PROGRESS
		func	:
		args	:
		return	:
		options :
		mode	:

	- process : IN PROGRESS
		func	:
		args	: 
			-d : display linked list
			-c : check hidden process			
		return	:
		options :
		mode	:

	- kmd5 :
		func	:
		args	:  sa output, sa:rva output, sa%rva%size output, 
			   sa%size output
				- sa : Symbol or addr
				- rva : Byte offset form the beginning (optional) 
				- size : Bytes number limit (optional)
					- If size is 0 or not put, we search 
					  the end of the function.
				- output : file output (optional)
			
		return	: $_ contains the md5 and $md5 contains the format
		options : /
		mode	: static/dynamic

	- kcmd5 : 
		func	:
		args	:  format, file
				- format : addr:mode:size:off:md5
				- file : filename
		return	: $_ is egal to the number of mismatch
		options	: /
		mode	: static/dynamic

	- kcore	: IN PROGRESS

[+] Options :

An option can be set directly in the shell or in the .kernshrc :
	configure libkernsh.option VALUE

[
 legends : (D) => default, 
	   (L) => specific to Linux, 
	   (N) => specific to Netbsd,
           (F) => specific to Freebsd 
	   
	   [S*] => any string value
	   [I*] => any integer value 
	   [L*] => any long value
]
	
	- libkernsh.device : The memory device which will be opened
		- /dev/mem (D)
		- /dev/kmem (L)
		- /proc/kcore (L)

	- libkernsh.mode : The mode to open the memory
		- read
		- write (D)
	
	- libkernsh.mmap : Mmap the memory (Must be USED to have all features)
		- 0
		- 1 (D)

	- libkernsh.mmap_size : Mmap's size of the main memory
		- 1000 * 1024 * 1024 (D)
		- [I*]
	
	- libkernsh.systemmap : (L) Path of the system map
		- /boot/System.map-`uname -r` (D)
		- [S*]

	- libkernsh.kernel : Path of the gzip kernel
		- /boot/vmlinuz (D) (L)
		- [S*]

	- libkernsh.gzipcmd : Which is the gzid command
		- /bin/gzip (D) (L)
		- [S*]

	- libkernsh.objcopycmd : Which is the objcopy command
		- /bin/objcopy (D) (L)
		- [S*]

	
	- libkernsh.ldcmd : Which is the ld command
		- /bin/ld (D) (L)
		- [S*]

	- libkernsh.kload : Which is the insert kernel module command
		- /bin/insmod (D) (L)
		- [S*]

	- libkernsh.kunload : Which is the remove kernel module command
		- /bin/rmmod (D) (L)
		- [S*]

	- libkernsh.kernelgz : The name to save the extract gzip kernel
		- vmlinuz.gz (D) (L)
		- [S*]		

	- libkernsh.kernelelf : The name of the extract/gunzip kernel
		- vmlinux (D) (L)
		- [S*]

	- libkernsh.storagepath : A path to store kernel and to 
				  open debug kernel
		- /tmp/ (D)
		- [S*]

	- libkernsh.nbsyscalls : The number of syscalls
		- 320 (D) (L)
		- [I*]

	- libkernsh.nilsyscalls : A position inside the syscall table 
				  of a free syscall
		- 17 (D) (L)
		- [I*]	

	- libkernsh.use_kernel : use the full debug kernel(not the gzip kernel)
		- 0 (D)
		- 1

	- libkernsh.without_kernel : not use the kernel, only memory
		- 0 (D)
		- 1

	- libkernsh.kernel_start : address of kernel start
		- 0xc0000000 (D) (L)
		- [L*]

	- libkernsh.kernel_end : address of kernel end
		- 0xc1000000 (D) (L)
		- [L*]

	- libkernsh.alloc : alloc/free contiguous memory(0) 
			    or non contiguous(1) 
		- 0 (D)
		- 1

	- libkernsh.fendsize : maximum size of a function
		- 0x1000 (D)
		- [L*]

[+] Variables

Some variables are available when the memory device is opened :
	$sys_call_table (D)
	$idt_base (D)
	$idt_limit (D)
	$gdt_base (D)
	$gdt_limit (D)
	$system_call (D) (L)

[+] Kernshrc 

You can use a .kernshrc in your home directory. There is some kernshrc in doc
directory.

[+] Examples

See examples directory.

[+] Authors 

Original version (0.1 => 0.2c) started in 2001 and original authors : 
	sauron, zorgon, kstat

The project has been transfered to pouik in 2007.

[+] Contacts

Information about kernsh : support at -nospam-kernsh.org

author's mail : pouik at -nospam-kernsh.org

[+] Bugs

Please use http://bts.eresi-project.org/

Compile libkernsh in debug mode, change in libkernsh/include/libkernsh.h 
the define :
	#define	__DEBUG_KERNSH__			0
in
	#define	__DEBUG_KERNSH__			1
	

[+] Url

eresi : http://www.eresi-project.org

kernsh : http://www.kernsh.org

blog : http://blog.kernsh.org
